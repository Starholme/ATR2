<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="./lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="./lib/bootstrap-icons-1.5.0/bootstrap-icons.css" rel="stylesheet">

    <link href="./lib/Chartjs-2.9.4/Chart.min.css" rel="stylesheet">

    <title>ATR!</title>
  </head>


  <body class="bg-dark">
    <main class="">
      <div class="container-md text-white">

        <!--Logo and Header-->
        <div class="row justify-content-md-center mb-3">
          <div class="card bg-dark text-center border-warning mt-3 col-md-6">
            <div style="margin-bottom: -24px;" class="card-body">
              <img style="margin-top:-15px;" src="rocket-crop.png">
              <h5 style="display:inline-block;" class="card-title">All The Rockets<br><br>
                <span id="rockets"><i class="bi bi-arrow-repeat"></i></span>
              </h5>
              <img style="margin-top:-15px;" src="rocket-crop.png">
            </div>
          </div>
        </div>

        <!--Global stats-->
        <div class="row justify-content-md-center">
          <div class="card bg-dark border-0 text-center mt-3 col-auto">
            <div class="card-body">
              <span class="badge bg-success">Players: <span id="online_players"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success">Time wasted: <span id="ticks"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="Current count of things in Subspace Storage">Junk heaped: <span id="subspace_stuff"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="EPU: Excessive Pollution Unit">Enviromentally Beneficial EPU's Generated: <span id="pollution"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="Trees. What did you expect?">True Enemies Terminated with Extreme Prejudice: <span id="trees"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="We killed lots of them">Combatants Liberated: <span id="enemies"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="I don't know why they don't like us">Combatant Homes Euphemised: <span id="homes"><i class="bi bi-arrow-repeat"></i></span></span>
              <span class="badge bg-success" title="Nukes.">Davy Crockett Deliveries: <span id="nukes"><i class="bi bi-arrow-repeat"></i></span></span>
            </div>
          </div>
        </div>

        <!--About, Rules-->
        <div class="row">
          <div class="col-md-6">
            <div class="card bg-dark border-secondary">
              <div class="card-body">
                <h5 class="card-title">Welcome to ATR!</h5>
                <p>ATR is a cooperative game that is intended to provide some continuity across map resets.</p>
                <p>Each ATR instance is connected to the other running instances in the <a href="https://github.com/clusterio/factorioClusterio">Clusterio</a> cluster.
                  <ul>
                    <li>Item sharing via the <a href="https://mods.factorio.com/mod/subspace_storage">Subspace Storage</a> mod</li>
                    <li>Chat to all servers via <a href="https://github.com/clusterio/factorioClusterio/blob/master/plugins/global_chat/README.md">Global Chat</a></li>
                    <li>Jump between servers via <a href="https://github.com/Hornwitser/server_select">Server Select</a></li>
                  </ul>
                </p>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card bg-dark border-secondary">
              <div class="card-body">
                <h5 class="card-title">Rules</h5>
                <p>
                  <ul>
                  <li>Be polite</li>
                  <li>Ask before changing other player's stuff</li>
                  <li>Have fun!</li>
                  </ul>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!--Server Cards-->
        <div class="row row-cols-1 row-cols-md-3 mt-3">
          <div class="col">
            <div class="card h-100 bg-dark border-success">
              <div class="card-body">
                <h5 class="card-title">World 4 <span class="badge bg-success">Active</span></h5>
                <p>
                  Let's get dangoreus!<br/>
                  <a href="https://mods.factorio.com/mod/dangOreus">Danger Ores</a>, very agressive biters. Clear out enough space to get to the item injector before it cramps your style.
                </p>
                <div class="server" data-instanceid="1516894863"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-success">
              <div class="card-body">
                <h5 class="card-title">World 5 <span class="badge bg-success">Active</span></h5>
                <p>
                  Into the void<br/>
                  Each player spawns on their own little space station. Expansion is based on time spent online.
                </p>
                <div class="server" data-instanceid="829665719"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-success">
              <div class="card-body">
                <h5 class="card-title">World 6 <span class="badge bg-success">Active</span></h5>
                <p>
                  Most of the Rockets!<br/>
                  This is where we launch rockets. This world runs all the time to eat up rocket parts, low density structure, rocket fuel, and satellites.
                </p>
                <div class="server" data-instanceid="2030805784"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-success">
              <div class="card-body">
                <h5 class="card-title">World 7 <span class="badge bg-success">Active</span></h5>
                <p>
                  Ghawar field<br/>
                  Lots of sand, oil, coal. Not much else.
                </p>
                <div class="server" data-instanceid="1231309118"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-success">
              <div class="card-body">
                <h5 class="card-title">World 8 <span class="badge bg-success">Active</span></h5>
                <p>
                  Bloodbath and Beyond<br/>
                  Peace through superior firepower
                </p>
                <div class="server" data-instanceid="1108202080"></div>
              </div>
            </div>
          </div>

          <!--Dying Template
          <div class="col">
            <div class="card h-100 bg-dark border-danger">
              <div class="card-body">
                <h5 class="card-title">World X <span class="badge bg-warning">Dying</span></h5>
                <p>
                  Enjoy your time on this thin slice of nauvis.<br/>
                  128 tile ribbon, no cliffs
                </p>
                <p>The world eater has arrived!</p>
                <div class="server" data-instanceid="1309285413"></div>
              </div>
            </div>
          </div>
          -->
        </div>

        <div class="row mt-3">
          <!--Discord-->
          <div class="col-auto border-secondary">
            <div class="card h-100 bg-dark border-secondary">
              <iframe src="https://discord.com/widget?id=852755130398670850&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
            </div>
          </div>
          <!--Contact-->
          <div class="col">
            <div class="card bg-dark border-0">
              <div class="card-body">
                <dl class="row">
                  <dt class="col-sm-2 text-center"><i class="bi-discord" style="font-size: 2rem;"></i></dt>
                  <dd class="col-sm-10">Join us on Discord! <a href="https://discord.gg/6dq2CbJ3Gx">https://discord.gg/6dq2CbJ3Gx</a></dd>

                  <dt class="col-sm-2 text-center"><i class="bi-github" style="font-size: 2rem;"></i></dt>
                  <dd class="col-sm-10">The scenario code and most of the configuration used to set up this cluster are available on GitHub <a href="https://github.com/Starholme/ATR2">https://github.com/Starholme/ATR2</a></dd>
                </dl>
              </div>
            </div>
          </div>
          <!--Changelog-->
          <div class="col-xs-12 mt-3">
            <div class="card bg-dark border-secondary">
              <div class="card-body">
                <ul>
                  <li>V2.0.0 2024-10-21
                    <ul>
                      <li>End of an era. Space age release today</li>
                      <li>Removing old servers</li>
                      <li>What comes next for ATR?</li>
                    </ul>
                  </li>
                  <li>V1.9.0 2022-09-17
                    <ul>
                      <li>Loading the Ammo Dump, Gnome Depot, Bloodbath and Beyond maps.</li>
                      <li>Biters more agressive expansion</li>
                      <li>Adaptive biter info in gui</li>
                    </ul>
                  </li>
                  <li>V1.8.0 2022-09-02
                    <ul>
                      <li>Prepping the Ghawar field</li>
                      <li>Biters adapt to damage type. Use variety to kill them.</li>
                      <li>Nuke craters slowly collapse to water.</li>
                    </ul>
                  </li>
                  <li>V1.7.0 2022-06-23
                    <ul>
                      <li>New Void World ready!</li>
                      <li>Improved behaviour of flore is lava damage</li>
                    </ul>
                  </li>
                  <li>V1.6.1 2022-06-12
                    <ul>
                      <li>Undecorator to reduce save size</li>
                    </ul>
                  </li>
                  <li>V1.6.0 2022-05-20
                    <ul>
                      <li>Danger Ores! New map started</li>
                    </ul>
                  </li>
                  <li>V1.5.1 2022-04-17
                    <ul>
                      <li>Fix teleport to other player spawn point bug</li>
                      <li>Fixed bug that could crash when generating new subspace storage pads. Again.</li>
                    </ul>
                  </li>
                  <li>V1.5.0 2022-04-09
                    <ul>
                      <li>More spawn options: Invite others to teleport to your spawn point!</li>
                      <li>Fixed bug that could crash when generating new subspace storage pads</li>
                      <li>Fixed archived servers showing as running</li>
                    </ul>
                  </li>
                  <li>V1.4.0 2022-03-21
                    <ul>
                      <li>Subspace Pads - Access points to the subspace storage are randomly spawned on the map. Search em out!</li>
                      <li>Split spawn points
                        <ul>
                          <li>Riff from <a href="https://mods.factorio.com/user/Oarc">OARC</a>'s scenario. Thank you for making it open source!</li>
                          <li>You can have your own spawn point</li>
                          <li>You can teleport home at any time</li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                  <li>V1.3.0 2022-02-10
                    <ul>
                      <li>Added Server Select plugin</li>
                      <li>Vehicles snap to grid faster</li>
                    </ul>
                  </li>
                  <li>V1.2.2 2022-02-08
                    <ul>
                      <li>Create server status badges, using Prometheus data</li>
                      <li>Catch bad or missing values from Prometheus, replace with N/A</li>
                    </ul>
                  </li>
                  <li>V1.2.0 2022-02-05
                    <ul>
                      <li>Added change log</li>
                      <li>Pulling stats from Prometheus</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <!--Old servers-->
          <div class="row row-cols-1 row-cols-md-3 mt-3">

          <div class="col">
            <div class="card h-100 bg-dark border-secondary">
              <div class="card-body">
                <h5 class="card-title">World 9 <span class="badge bg-secondary">Dead</span></h5>
                <p>
                  Gnome Depot<br/>
                  74 aisles of the stuff you need
                </p>
				<p>Death by Space Age</p>
				<p>Download save file <a href="https://alltherockets.duckdns.org/archive/world9.zip">world9.zip</a></p>
                <div class="server" data-instanceid="2027679344"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-secondary">
              <div class="card-body">
                <h5 class="card-title">World 10 <span class="badge bg-secondary">Dead</span></h5>
                <p>
                  Ammo Dump<br/>
                  If it explodes, maims, obliterates or perforates, we have it.
                </p>
				<p>Death by Space Age</p>
				<p>Download save file <a href="https://alltherockets.duckdns.org/archive/world10.zip">world10.zip</a></p>
                <div class="server" data-instanceid="2043360635"></div>
              </div>
            </div>
          </div>

          <div class="col">
            <div class="card h-100 bg-dark border-secondary">
              <div class="card-body">
                <h5 class="card-title">World 3 <span class="badge bg-secondary">Dead</span></h5>
                <p>
                  It's the finest of the flavors<br/>
                  Just a vanilla world.
                </p>
				<p>Death by overwhelming biter resistances</p>
				<p>Download save file <a href="https://alltherockets.duckdns.org/archive/atr_world_3.zip">World3.zip</a></p>
                <div class="server" data-instanceid="783120978"></div>
              </div>
            </div>
          </div>

            <div class="col">
              <div class="card h-100 bg-dark border-secondary">
                <div class="card-body">
                  <h5 class="card-title">World 2 <span class="badge bg-secondary">Dead</span></h5>
                  <p>
                    Riches abound, spread far and wide.<br/>
                    Very rich large resources, low frequency
                  </p>
                  <p>Death by lack of activity</p>
                  <p>Download save file <a href="https://alltherockets.duckdns.org/archive/world2.zip">World2.zip</a></p>
                  <div class="server" data-instanceid="1989355807"></div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="card h-100 bg-dark border-secondary">
                <div class="card-body">
                  <h5 class="card-title">World 1 <span class="badge bg-secondary">Dead</span></h5>
                  <p>
                    Enjoy your time on this thin slice of nauvis.<br/>
                    128 tile ribbon, no cliffs
                  </p>
                  <p>Death by lack of activity</p>
                  <p>Download save file <a href="https://alltherockets.duckdns.org/archive/world1.zip">World1.zip</a></p>
                  <div class="server" data-instanceid="1309285413"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </main>

    <footer class="footer py-3">
      <div class="container">
        <span id="version" class="text-muted"></span>
        <span id="timestamp" class="text-muted"></span>
      </div>
    </footer>

    <script src="./lib/jquery-3.6.0.min.js"></script>
    <script src="./lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="./lib/luxon.min.js"></script>
    <script src="./lib/moment.js"></script>
    <script src="./lib/Chartjs-2.9.4/Chart.min.js"></script>
    <script src="./lib/prometheus-query.umd.min.js"></script>
    <script src="./lib/chartjs-plugin-datasource-prometheus.umd.min.js"></script>

    <script>
      (function(){
        const VERSION = '1.8.0';
        const PROMETHEUS_ENDPOINT = "https://alltherockets.duckdns.org/prometheus/";
        const MS_PER_STAT = 2000;

        const DateTime = luxon.DateTime;

        $(document).ready(function(){
          console.log("ready");
          $('#version').text('V' + VERSION);
          $('#timestamp').text(DateTime.utc().toLocaleString(DateTime.TIME_24_WITH_SHORT_OFFSET));

          SetupPromQueries();
        });

        function SetupPromQueries(){

          //Title
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_force_flow_statistics{force="player",statistic="item_production_statistics",direction="input",name="rocket-part"})', $('#rockets'), StatsUpdater.TYPES.SPAN, rocketPartsToRocketsLaunched);

          //Each instance
          $('.server').each(function(){
            const instanceId = this.dataset.instanceid;
            const serverCard = $(this.parentElement);

            let badges = "";
            //Instance status
            badges += '<span class="badge bg-secondary">Server: <span class="status">...</span></span> ';
            //Player count
            badges += '<span class="badge bg-secondary">Players: <span class="players">...</span></span> ';
            //Ticks
            badges += '<span class="badge bg-secondary time">...</span>'
            $(this).append(badges);

            StatsUpdater.Add('clusterio_statistics_exporter_instance_player_count{instance_id="'+instanceId+'"}', $('.players', serverCard), StatsUpdater.TYPES.SPAN);
            StatsUpdater.Add('clusterio_statistics_exporter_instance_game_ticks_total{instance_id="'+instanceId+'"}', $('.time', serverCard), StatsUpdater.TYPES.SPAN, ticksToTime);
            StatsUpdater.Add('clusterio_statistics_exporter_instance_player_count{instance_id="'+instanceId+'"}', null, StatsUpdater.TYPES.CALLBACK, function(val){
              if (val == "N/A"){
                $('.status', serverCard).text("OFFLINE").parent().addClass("bg-danger").removeClass("bg-success");
              }
              else{
                $('.status', serverCard).text("Running").parent().addClass("bg-success").removeClass("bg-danger");
              }
            });
          });

          //Top badges bar
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_player_count)', $('#online_players'), StatsUpdater.TYPES.SPAN);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_game_ticks_total{instance_id!="2030805784"})', $('#ticks'), StatsUpdater.TYPES.SPAN, ticksToTime);
          StatsUpdater.Add('sum(clusterio_subspace_storage_master_inventory)', $('#subspace_stuff'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_force_flow_statistics{name=~".*tree.*|.*trunk.*"})', $('#trees'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_force_flow_statistics{name=~".*-biter|.*-spitter|.*worm-turret", direction="input"})', $('#enemies'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_force_flow_statistics{name=~".*-spawner", direction="input"})', $('#homes'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_game_flow_statistics{direction="input", statistic="pollution_statistics"})', $('#pollution'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
          StatsUpdater.Add('sum(clusterio_statistics_exporter_instance_force_flow_statistics{force="player",statistic="item_production_statistics",direction="output",name="atomic-bomb"})', $('#nukes'), StatsUpdater.TYPES.SPAN, abbreviateNumber);
        }

        const StatsUpdater = (function(){
          let exports = {};

          const prom = new Prometheus.PrometheusDriver({
            endpoint: PROMETHEUS_ENDPOINT,
            baseURL: "/api/v1" // default value
          });

          const stats = new Array();
          let next = 0;
          let len = 0;
          let firstRun = true;

          function UpdateNext(){
            if (next >= len){
              next = 0;
              firstRun = false;
              setTimeout(UpdateNext, firstRun? 100 : MS_PER_STAT);
              return;
            }

            let stat = stats[next];
            console.log("Updating stat " + next + ": " + stat.promql);

            if (stat.type == TYPES.CONSOLE){
              prom.instantQuery(stat.promql)
                  .then((res) => {
                      const series = res.result;
                      series.forEach((serie) => {
                          console.log("Serie:", serie.metric.toString());
                          console.log("Time:", serie.value.time);
                          console.log("Value:", serie.value.value);
                      });
                  })
                  .catch(console.error);
            }
            if (stat.type == TYPES.SPAN){
              prom.instantQuery(stat.promql)
                  .then((res) => {
                      let val = "N/A"
                      try {
                        val = res.result[0].value.value;
                        if (stat.formatter !== null) val = stat.formatter(val);
                      } catch (error) {
                        //Not available.
                      }
                      stat.dom.text(val);
                  })
                  .catch(console.error);
            }
            if (stat.type == TYPES.CALLBACK){
              prom.instantQuery(stat.promql)
                  .then((res) => {
                      let val = "N/A"
                      try {
                        val = res.result[0].value.value;
                      } catch (error) {
                        //Not available.
                      }
                      stat.formatter(val);
                  })
                  .catch(console.error);
            }

            next++;
            //On the first run, load all the data fast
            setTimeout(UpdateNext, firstRun? 100 : MS_PER_STAT);
          }
          //Wait 5 seconds before starting to load stats
          setTimeout(UpdateNext, 5000);

          exports.Add = function(promql, dom, type, formatter){
            if (formatter == undefined) formatter = null;
            if (type == TYPES.CALLBACK && formatter == null){
              alert("No callback supplied! - " + promql);
              return;
            }
            stats.push({promql, dom, type, formatter});
            len++;
          }

          const TYPES = {
            CONSOLE: "CONSOLE",
            SPAN: "SPAN",
            CALLBACK: "CALLBACK"
          };
          exports.TYPES = TYPES;

          return exports;
        })();
        let statsList = new Array();


        const SI_SYMBOL = ["", "k", "M", "G", "T", "P", "E"];
        function abbreviateNumber(number, tierModifier = 0){

            // what tier? (determines SI symbol)
            var tier = Math.log10(Math.abs(number)) / 3 | 0;

            //Adjust the tier if requested
            tier = tier + tierModifier;
            if (tier < 0) tier = 0;

            // if zero, we don't need a suffix
            if(tier == 0) return number;

            // get suffix and determine scale
            var suffix = SI_SYMBOL[tier];
            var scale = Math.pow(10, tier * 3);

            // scale the number
            var scaled = number / scale;

            // format number and add suffix
            return scaled.toFixed(1) + suffix;
        }

        function rocketPartsToRocketsLaunched(number){
          number = Math.floor(number / 100);
          return abbreviateNumber(number, -1);
        }

        function ticksToTime(ticks){
          //milliseconds
          const ms = Math.round(ticks/60) * 1000;

          let d = luxon.Duration.fromMillis(ms);

          return d.toFormat("d 'Days', hh:mm:ss");
        }

      })();

      //Debugging bits
      if (window.location.protocol == 'file:'){
        setTimeout(function(){
            document.location.reload();
          }, 60 * 1000);
      }
    </script>
  </body>
</html>
